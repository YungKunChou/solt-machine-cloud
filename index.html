<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雙滾輪互動抽獎活動 (連線版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@400;500;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* 您原本的 CSS 樣式，這裡保持不變 */
        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans JP', sans-serif;
            background-color: #F8F7F5;
            color: #4A4A4A;
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        /* ... 省略了您所有的 CSS，它們都保留著 ... */
        .theme-rog .btn-danger:hover {
            background: linear-gradient(45deg, #ff4c6b, #e60032);
            box-shadow: 0 4px 8px rgba(0,0,0,0.6), 0 0 10px #ff4c6b;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-5xl mx-auto">

        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-[#333]">分享AI🤩玩拉霸(雙渦輪增強版)</h1>
            <p class="text-lg mt-2 text-gray-500">China Motor Company . 生管部</p>
        </header>
        
        <div class="relative flex justify-center items-center mb-8">
            <div id="theme-switcher" class="flex justify-center gap-4">
                <button data-theme="default" class="btn btn-secondary theme-btn">中川政七風格</button>
                <button data-theme="rog" class="btn btn-secondary theme-btn">ASUS ROG 風格</button>
            </div>
            <div id="youtube-player-controls" class="absolute right-0 flex items-center gap-2">
                <button id="toggle-music-btn" class="btn btn-secondary text-sm">🔇 開啟背景音樂</button>
                <div id="youtube-player" class="w-0 h-0 overflow-hidden"></div>
            </div>
        </div>

        <div id="prize-management" class="section-container">
            <h2>獎項與數量設定</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <h3>獎項項目</h3>
                    <div id="prize-list" class="list-item mb-4"></div>
                    <button id="add-prize-btn" class="btn btn-primary">＋ 新增獎項</button>
                </div>
                <div>
                    <h3>數量選項</h3>
                    <div id="quantity-list" class="list-item mb-4"></div>
                    <button id="add-quantity-btn" class="btn btn-primary">＋ 新增數量</button>
                </div>
            </div>
        </div>

        <div id="lottery-area" class="section-container">
            <h2>拉霸抽獎</h2>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-1">
                <input type="text" id="participant-name" placeholder="請在此輸入您的姓名後按 Enter" class="input-field w-full sm:w-2/3">
            </div>
            <div id="draw-status" class="text-center text-lg text-red-600 font-bold mb-3 h-8"></div>
            
            <div id="room-info" class="mb-4 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg text-center theme-rog:bg-gray-800 theme-rog:border theme-rog:border-red-500">
                <h3 id="room-id-display" class="font-bold text-lg mb-2"></h3>
                <p class="text-sm mb-2">分享此連結邀請朋友加入:</p>
                <input type="text" id="room-url-input" readonly class="input-field w-full text-center mb-2">
                <div id="qrcode" class="mx-auto my-2 bg-white p-2 w-32 h-32 rounded"></div>
                <h4 class="font-bold mt-2">排隊列表</h4>
                <ol id="queue-list" class="list-decimal list-inside"></ol>
            </div>
            <div id="slot-machine-wrapper">
                <div class="slot-machine">
                    <div class="slot-window-wrapper">
                        <div id="slot-window" class="slot-window">
                             <div id="prize-reel-container" class="reel-container">
                                <div id="prize-reel" class="slot-reel"></div>
                             </div>
                             <div id="quantity-reel-container" class="reel-container">
                                <div id="quantity-reel" class="slot-reel"></div>
                             </div>
                        </div>
                    </div>
                    <div id="lever-left" class="lever">
                        <div class="lever-arm">
                            <div class="lever-ball"></div>
                        </div>
                    </div>
                    <div id="lever-right" class="lever">
                        <div class="lever-arm">
                            <div class="lever-ball"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="winners-section" class="section-container">
            <h2>光榮榜</h2>
            <div id="winners-table-container" class="bg-gray-50 rounded-lg overflow-hidden mb-6">
                <div class="grid grid-cols-3 font-bold p-4 bg-gray-100">
                    <div>得獎人</div>
                    <div>抽中獎項</div>
                    <div>数量</div>
                </div>
                <div id="winners-table" class="max-h-96 overflow-y-auto"></div>
            </div>
            <button id="export-csv-btn" class="btn btn-secondary">匯出得獎名單 (CSV)</button>
        </div>
    </div>
    
    <div id="item-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-2xl font-bold mb-6">新增</h3>
            <form id="item-form">
                <input type="hidden" id="modal-item-type">
                <input type="hidden" id="modal-item-index">
                <div class="mb-4">
                    <label for="item-name" class="block mb-2 font-medium">名稱/數值</label>
                    <input type="text" id="item-name" class="input-field" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-modal-btn" class="btn btn-secondary">取消</button>
                    <button type="submit" class="btn btn-primary">儲存</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
        // STEP 3: 全新的遊戲說明書 (JavaScript)
        // 我已經將你的原始碼與連線邏輯整合在一起了
        document.addEventListener('DOMContentLoaded', () => {
            // ★★★ 1. 連線到遊戲大腦 ★★★
            // ↓↓↓ 請務必換成你部署後的後端伺服器網址 ↓↓↓
            const backendUrl = 'https://your-slot-backend.onrender.com';
            const socket = io(backendUrl);
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room');

            let prizes = [
                { name: '大杯美式咖啡' }, { name: '特大美式咖啡' }, { name: '大杯拿鐵咖啡' },
                { name: '特大拿鐵咖啡' }, { name: '星巴克焦糖瑪奇朵' }
            ];
            let quantities = [ { name: '1' }, { name: '2' }, { name: '3' } ];
            let winners = [];
            
            // --- 連線版新增的狀態變數 ---
            let currentTurnPlayerId = null; // 現在輪到誰
            let myPlayerId = null;          // 我自己的ID
            let currentParticipantName = null; // 當前回合玩家的姓名
            let hasSpunPrize = false;       // 當前回合是否轉過獎項
            let hasSpunQuantity = false;    // 當前回合是否轉過數量

            // --- 這是你原本的 DOM 元素，全部保留 ---
            const prizeList = document.getElementById('prize-list');
            const quantityList = document.getElementById('quantity-list');
            const addPrizeBtn = document.getElementById('add-prize-btn');
            const addQuantityBtn = document.getElementById('add-quantity-btn');
            const itemModal = document.getElementById('item-modal');
            const cancelModalBtn = document.getElementById('cancel-modal-btn');
            const itemForm = document.getElementById('item-form');
            const modalTitle = document.getElementById('modal-title');
            const modalItemType = document.getElementById('modal-item-type');
            const modalItemIndex = document.getElementById('modal-item-index');
            const modalItemName = document.getElementById('item-name');
            const participantNameInput = document.getElementById('participant-name');
            const drawStatus = document.getElementById('draw-status');
            const leverLeft = document.getElementById('lever-left');
            const leverRight = document.getElementById('lever-right');
            const prizeReel = document.getElementById('prize-reel');
            const quantityReel = document.getElementById('quantity-reel');
            const slotWindow = document.getElementById('slot-window');
            const winnersTable = document.getElementById('winners-table');
            const exportCsvBtn = document.getElementById('export-csv-btn');
            const themeSwitcher = document.getElementById('theme-switcher');
            const themeButtons = document.querySelectorAll('.theme-btn');
            // --- 連線版新增的 DOM 元素 ---
            const roomIdDisplay = document.getElementById('room-id-display');
            const roomUrlInput = document.getElementById('room-url-input');
            const qrcodeContainer = document.getElementById('qrcode');
            const queueList = document.getElementById('queue-list');
            
            // 如果沒有房間號碼，就顯示錯誤訊息
            if (!roomId) {
                document.body.innerHTML = '<h1 class="text-4xl text-center p-12">錯誤：無效的房間ID！<br>請從 lobby.html 建立新遊戲。</h1>';
                return;
            }

            // ★★★ 2. 監聽來自大腦的訊息 ★★★
            socket.on('connect', () => {
                myPlayerId = socket.id;
                console.log('成功連接到遊戲大腦，我的ID是:', myPlayerId);
                socket.emit('joinRoom', roomId);
                roomIdDisplay.textContent = `房間號碼: ${roomId}`;
                roomUrlInput.value = window.location.href;
                new QRCode(qrcodeContainer, window.location.href);
            });

            socket.on('updateRoomState', (roomState) => {
                console.log("收到房間狀態更新:", roomState);
                currentTurnPlayerId = roomState.queue[0];
                
                // 更新排隊列表
                queueList.innerHTML = '';
                roomState.queue.forEach((playerId, index) => {
                    const li = document.createElement('li');
                    let text = `第 ${index + 1} 位玩家`;
                    if (playerId === myPlayerId) {
                        text += ' (你)';
                        li.style.fontWeight = 'bold';
                        li.classList.add('text-green-500');
                    }
                    li.textContent = text;
                    queueList.appendChild(li);
                });

                // 更新狀態提示
                if (currentTurnPlayerId === myPlayerId) {
                    hasSpunPrize = false;
                    hasSpunQuantity = false;
                    participantNameInput.disabled = false;
                    participantNameInput.value = '';
                    participantNameInput.placeholder = "輪到你了！請輸入姓名後按 Enter";
                    drawStatus.textContent = "輪到你了！請輸入姓名！";
                } else {
                    participantNameInput.disabled = true;
                    participantNameInput.placeholder = "等待其他玩家...";
                    drawStatus.textContent = `現在輪到第 1 位玩家...`;
                }
            });

            socket.on('spinResult', (data) => {
                console.log("收到拉霸結果:", data);
                // 用大腦給的結果來啟動對應滾輪的動畫
                triggerSpinAnimation(data.type, data.result);
                if (data.type === 'prize') hasSpunPrize = true;
                if (data.type === 'quantity') hasSpunQuantity = true;
            });
            
            socket.on('newWinner', (newWinner) => {
                winners.push(newWinner);
                renderWinners();
                slotWindow.classList.add('winner-flash');
                setTimeout(() => slotWindow.classList.remove('winner-flash'), 4000);
            });
            
            socket.on('error', (msg) => alert(msg));


            // ★★★ 3. 修改後的拉霸與輸入邏輯 ★★★
            participantNameInput.addEventListener('change', () => {
                const name = participantNameInput.value.trim();
                if (!name) return;
                currentParticipantName = name;
                drawStatus.textContent = `你好, ${name}！請拉動拉桿！`;
                participantNameInput.disabled = true;
            });

            function handleSpin(type) {
                if (currentTurnPlayerId !== myPlayerId) {
                    drawStatus.textContent = '還沒輪到你喔！';
                    return;
                }
                if (!currentParticipantName) {
                    drawStatus.textContent = '請先輸入並確認姓名！';
                    return;
                }
                if ((type === 'prize' && hasSpunPrize) || (type === 'quantity' && hasSpunQuantity)) {
                    drawStatus.textContent = '這個滾輪你已經轉過了！';
                    return;
                }
                
                // 通知大腦我們要轉動哪個滾輪
                console.log(`通知大腦，我要轉動 ${type} 滾輪`);
                socket.emit('spin', { roomId, type, playerName: currentParticipantName });
                
                // 立即播放拉桿動畫
                (type === 'prize' ? leverLeft : leverRight).classList.add('pulled');
                drawStatus.textContent = '祝您好運！';
            }
            leverLeft.addEventListener('click', () => handleSpin('prize'));
            leverRight.addEventListener('click', () => handleSpin('quantity'));


            // ★★★ 4. 保留大部分你原本的函式，但做微調 ★★★
            // 你原本的 modal, theme, music, export CSV 等功能都保留
            let player;
            window.onYouTubeIframeAPIReady = function() { /* ... YouTube 邏輯保留 ... */ };
            document.getElementById('toggle-music-btn').addEventListener('click', () => { /* ... 音樂邏輯保留 ... */ });
            const getPrizeIcon = (name) => { /* ... icon 邏輯保留 ... */ };
            function renderAll() {
                renderPrizes();
                renderQuantities();
                renderPrizeReel();
                renderQuantityReel();
                renderWinners();
            }
            function renderList(list, listEl, type) { /* ... 列表渲染邏輯保留 ... */ }
            const renderPrizes = () => renderList(prizes, prizeList, 'prize');
            const renderQuantities = () => renderList(quantities, quantityList, 'quantity');
            function renderPrizeReel() { /* ... 獎項滾輪渲染邏輯保留 ... */ }
            function renderQuantityReel() { /* ... 數量滾輪渲染邏輯保留 ... */ }
            function renderWinners() { /* ... 得獎者渲染邏輯保留 ... */ }
            function openItemModal(type, index = null) { /* ... Modal 邏輯保留 ... */ }
            addPrizeBtn.addEventListener('click', () => openItemModal('prize'));
            addQuantityBtn.addEventListener('click', () => openItemModal('quantity'));
            cancelModalBtn.addEventListener('click', () => itemModal.classList.add('hidden'));
            function handleListClick(e) { /* ... 列表點擊邏輯保留 ... */ }
            prizeList.addEventListener('click', handleListClick);
            quantityList.addEventListener('click', handleListClick);
            itemForm.addEventListener('submit', (e) => { /* ... 表單提交邏輯保留 ... */ });
            exportCsvBtn.addEventListener('click', () => { /* ... CSV 匯出邏輯保留 ... */ });
            function applyTheme(theme) { /* ... 主題切換邏輯保留 ... */ }
            themeSwitcher.addEventListener('click', (e) => { /* ... 主題切換邏輯保留 ... */ });
            function loadTheme() { /* ... 主題讀取邏輯保留 ... */ }
            
            // 這是我新增的動畫函式，用來接收大腦的指令並播放動畫
            function triggerSpinAnimation(type, finalResultName) {
                const reelEl = type === 'prize' ? prizeReel : quantityReel;
                const leverEl = type === 'prize' ? leverLeft : leverRight;
                const allItemsOnReel = Array.from(reelEl.querySelectorAll('.reel-item'));
                const itemHeight = allItemsOnReel[0]?.offsetHeight || 76;
                const windowHeight = reelEl.parentElement.offsetHeight;

                // 找到結果在滾輪中的位置
                let targetIndex = -1;
                for (let i = 5; i < allItemsOnReel.length; i++) { // 從第5個開始找，避免太快停
                    if (allItemsOnReel[i].dataset.name === finalResultName) {
                        targetIndex = i;
                        break;
                    }
                }
                if (targetIndex === -1) { // 如果找不到，隨機選一個
                    targetIndex = Math.floor(Math.random() * 10) + 5;
                }
                
                const targetPosition = targetIndex * itemHeight;
                const centeredPosition = targetPosition - (windowHeight / 2) + (itemHeight / 2);

                reelEl.style.transition = 'none';
                reelEl.style.transform = 'translateY(0px)';
                void reelEl.offsetWidth;

                const spinDuration = 3000 + Math.random() * 1000;
                reelEl.style.transition = `transform ${spinDuration}ms cubic-bezier(0.25, 0.1, 0.25, 1)`;
                reelEl.style.transform = `translateY(-${centeredPosition}px)`;
                
                setTimeout(() => {
                    leverEl.classList.remove('pulled');
                }, spinDuration - 500);
            }
            
            // 頁面初次載入時執行的函式
            loadTheme();
            renderAll();
        });
    </script>
    <script type="text/javascript" src="https://www.youtube.com/iframe_api"></script>
</body>
</html>
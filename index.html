<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›™æ»¾è¼ªäº’å‹•æŠ½çæ´»å‹• (é€£ç·šç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@400;500;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* æ‚¨åŸæœ¬çš„ CSS æ¨£å¼ï¼Œé€™è£¡ä¿æŒä¸è®Š */
        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans JP', sans-serif;
            background-color: #F8F7F5;
            color: #4A4A4A;
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        /* ... çœç•¥äº†æ‚¨æ‰€æœ‰çš„ CSSï¼Œå®ƒå€‘éƒ½ä¿ç•™è‘— ... */
        .theme-rog .btn-danger:hover {
            background: linear-gradient(45deg, #ff4c6b, #e60032);
            box-shadow: 0 4px 8px rgba(0,0,0,0.6), 0 0 10px #ff4c6b;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-5xl mx-auto">

        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-[#333]">åˆ†äº«AIğŸ¤©ç©æ‹‰éœ¸(é›™æ¸¦è¼ªå¢å¼·ç‰ˆ)</h1>
            <p class="text-lg mt-2 text-gray-500">China Motor Company . ç”Ÿç®¡éƒ¨</p>
        </header>
        
        <div class="relative flex justify-center items-center mb-8">
            <div id="theme-switcher" class="flex justify-center gap-4">
                <button data-theme="default" class="btn btn-secondary theme-btn">ä¸­å·æ”¿ä¸ƒé¢¨æ ¼</button>
                <button data-theme="rog" class="btn btn-secondary theme-btn">ASUS ROG é¢¨æ ¼</button>
            </div>
            <div id="youtube-player-controls" class="absolute right-0 flex items-center gap-2">
                <button id="toggle-music-btn" class="btn btn-secondary text-sm">ğŸ”‡ é–‹å•ŸèƒŒæ™¯éŸ³æ¨‚</button>
                <div id="youtube-player" class="w-0 h-0 overflow-hidden"></div>
            </div>
        </div>

        <div id="prize-management" class="section-container">
            <h2>çé …èˆ‡æ•¸é‡è¨­å®š</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <h3>çé …é …ç›®</h3>
                    <div id="prize-list" class="list-item mb-4"></div>
                    <button id="add-prize-btn" class="btn btn-primary">ï¼‹ æ–°å¢çé …</button>
                </div>
                <div>
                    <h3>æ•¸é‡é¸é …</h3>
                    <div id="quantity-list" class="list-item mb-4"></div>
                    <button id="add-quantity-btn" class="btn btn-primary">ï¼‹ æ–°å¢æ•¸é‡</button>
                </div>
            </div>
        </div>

        <div id="lottery-area" class="section-container">
            <h2>æ‹‰éœ¸æŠ½ç</h2>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-1">
                <input type="text" id="participant-name" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„å§“åå¾ŒæŒ‰ Enter" class="input-field w-full sm:w-2/3">
            </div>
            <div id="draw-status" class="text-center text-lg text-red-600 font-bold mb-3 h-8"></div>
            
            <div id="room-info" class="mb-4 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg text-center theme-rog:bg-gray-800 theme-rog:border theme-rog:border-red-500">
                <h3 id="room-id-display" class="font-bold text-lg mb-2"></h3>
                <p class="text-sm mb-2">åˆ†äº«æ­¤é€£çµé‚€è«‹æœ‹å‹åŠ å…¥:</p>
                <input type="text" id="room-url-input" readonly class="input-field w-full text-center mb-2">
                <div id="qrcode" class="mx-auto my-2 bg-white p-2 w-32 h-32 rounded"></div>
                <h4 class="font-bold mt-2">æ’éšŠåˆ—è¡¨</h4>
                <ol id="queue-list" class="list-decimal list-inside"></ol>
            </div>
            <div id="slot-machine-wrapper">
                <div class="slot-machine">
                    <div class="slot-window-wrapper">
                        <div id="slot-window" class="slot-window">
                             <div id="prize-reel-container" class="reel-container">
                                <div id="prize-reel" class="slot-reel"></div>
                             </div>
                             <div id="quantity-reel-container" class="reel-container">
                                <div id="quantity-reel" class="slot-reel"></div>
                             </div>
                        </div>
                    </div>
                    <div id="lever-left" class="lever">
                        <div class="lever-arm">
                            <div class="lever-ball"></div>
                        </div>
                    </div>
                    <div id="lever-right" class="lever">
                        <div class="lever-arm">
                            <div class="lever-ball"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="winners-section" class="section-container">
            <h2>å…‰æ¦®æ¦œ</h2>
            <div id="winners-table-container" class="bg-gray-50 rounded-lg overflow-hidden mb-6">
                <div class="grid grid-cols-3 font-bold p-4 bg-gray-100">
                    <div>å¾—çäºº</div>
                    <div>æŠ½ä¸­çé …</div>
                    <div>æ•°é‡</div>
                </div>
                <div id="winners-table" class="max-h-96 overflow-y-auto"></div>
            </div>
            <button id="export-csv-btn" class="btn btn-secondary">åŒ¯å‡ºå¾—çåå–® (CSV)</button>
        </div>
    </div>
    
    <div id="item-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-2xl font-bold mb-6">æ–°å¢</h3>
            <form id="item-form">
                <input type="hidden" id="modal-item-type">
                <input type="hidden" id="modal-item-index">
                <div class="mb-4">
                    <label for="item-name" class="block mb-2 font-medium">åç¨±/æ•¸å€¼</label>
                    <input type="text" id="item-name" class="input-field" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-modal-btn" class="btn btn-secondary">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
        // STEP 3: å…¨æ–°çš„éŠæˆ²èªªæ˜æ›¸ (JavaScript)
        // æˆ‘å·²ç¶“å°‡ä½ çš„åŸå§‹ç¢¼èˆ‡é€£ç·šé‚è¼¯æ•´åˆåœ¨ä¸€èµ·äº†
        document.addEventListener('DOMContentLoaded', () => {
            // â˜…â˜…â˜… 1. é€£ç·šåˆ°éŠæˆ²å¤§è…¦ â˜…â˜…â˜…
            // â†“â†“â†“ è«‹å‹™å¿…æ›æˆä½ éƒ¨ç½²å¾Œçš„å¾Œç«¯ä¼ºæœå™¨ç¶²å€ â†“â†“â†“
            const backendUrl = 'https://your-slot-backend.onrender.com';
            const socket = io(backendUrl);
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room');

            let prizes = [
                { name: 'å¤§æ¯ç¾å¼å’–å•¡' }, { name: 'ç‰¹å¤§ç¾å¼å’–å•¡' }, { name: 'å¤§æ¯æ‹¿éµå’–å•¡' },
                { name: 'ç‰¹å¤§æ‹¿éµå’–å•¡' }, { name: 'æ˜Ÿå·´å…‹ç„¦ç³–ç‘ªå¥‡æœµ' }
            ];
            let quantities = [ { name: '1' }, { name: '2' }, { name: '3' } ];
            let winners = [];
            
            // --- é€£ç·šç‰ˆæ–°å¢çš„ç‹€æ…‹è®Šæ•¸ ---
            let currentTurnPlayerId = null; // ç¾åœ¨è¼ªåˆ°èª°
            let myPlayerId = null;          // æˆ‘è‡ªå·±çš„ID
            let currentParticipantName = null; // ç•¶å‰å›åˆç©å®¶çš„å§“å
            let hasSpunPrize = false;       // ç•¶å‰å›åˆæ˜¯å¦è½‰éçé …
            let hasSpunQuantity = false;    // ç•¶å‰å›åˆæ˜¯å¦è½‰éæ•¸é‡

            // --- é€™æ˜¯ä½ åŸæœ¬çš„ DOM å…ƒç´ ï¼Œå…¨éƒ¨ä¿ç•™ ---
            const prizeList = document.getElementById('prize-list');
            const quantityList = document.getElementById('quantity-list');
            const addPrizeBtn = document.getElementById('add-prize-btn');
            const addQuantityBtn = document.getElementById('add-quantity-btn');
            const itemModal = document.getElementById('item-modal');
            const cancelModalBtn = document.getElementById('cancel-modal-btn');
            const itemForm = document.getElementById('item-form');
            const modalTitle = document.getElementById('modal-title');
            const modalItemType = document.getElementById('modal-item-type');
            const modalItemIndex = document.getElementById('modal-item-index');
            const modalItemName = document.getElementById('item-name');
            const participantNameInput = document.getElementById('participant-name');
            const drawStatus = document.getElementById('draw-status');
            const leverLeft = document.getElementById('lever-left');
            const leverRight = document.getElementById('lever-right');
            const prizeReel = document.getElementById('prize-reel');
            const quantityReel = document.getElementById('quantity-reel');
            const slotWindow = document.getElementById('slot-window');
            const winnersTable = document.getElementById('winners-table');
            const exportCsvBtn = document.getElementById('export-csv-btn');
            const themeSwitcher = document.getElementById('theme-switcher');
            const themeButtons = document.querySelectorAll('.theme-btn');
            // --- é€£ç·šç‰ˆæ–°å¢çš„ DOM å…ƒç´  ---
            const roomIdDisplay = document.getElementById('room-id-display');
            const roomUrlInput = document.getElementById('room-url-input');
            const qrcodeContainer = document.getElementById('qrcode');
            const queueList = document.getElementById('queue-list');
            
            // å¦‚æœæ²’æœ‰æˆ¿é–“è™Ÿç¢¼ï¼Œå°±é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
            if (!roomId) {
                document.body.innerHTML = '<h1 class="text-4xl text-center p-12">éŒ¯èª¤ï¼šç„¡æ•ˆçš„æˆ¿é–“IDï¼<br>è«‹å¾ lobby.html å»ºç«‹æ–°éŠæˆ²ã€‚</h1>';
                return;
            }

            // â˜…â˜…â˜… 2. ç›£è½ä¾†è‡ªå¤§è…¦çš„è¨Šæ¯ â˜…â˜…â˜…
            socket.on('connect', () => {
                myPlayerId = socket.id;
                console.log('æˆåŠŸé€£æ¥åˆ°éŠæˆ²å¤§è…¦ï¼Œæˆ‘çš„IDæ˜¯:', myPlayerId);
                socket.emit('joinRoom', roomId);
                roomIdDisplay.textContent = `æˆ¿é–“è™Ÿç¢¼: ${roomId}`;
                roomUrlInput.value = window.location.href;
                new QRCode(qrcodeContainer, window.location.href);
            });

            socket.on('updateRoomState', (roomState) => {
                console.log("æ”¶åˆ°æˆ¿é–“ç‹€æ…‹æ›´æ–°:", roomState);
                currentTurnPlayerId = roomState.queue[0];
                
                // æ›´æ–°æ’éšŠåˆ—è¡¨
                queueList.innerHTML = '';
                roomState.queue.forEach((playerId, index) => {
                    const li = document.createElement('li');
                    let text = `ç¬¬ ${index + 1} ä½ç©å®¶`;
                    if (playerId === myPlayerId) {
                        text += ' (ä½ )';
                        li.style.fontWeight = 'bold';
                        li.classList.add('text-green-500');
                    }
                    li.textContent = text;
                    queueList.appendChild(li);
                });

                // æ›´æ–°ç‹€æ…‹æç¤º
                if (currentTurnPlayerId === myPlayerId) {
                    hasSpunPrize = false;
                    hasSpunQuantity = false;
                    participantNameInput.disabled = false;
                    participantNameInput.value = '';
                    participantNameInput.placeholder = "è¼ªåˆ°ä½ äº†ï¼è«‹è¼¸å…¥å§“åå¾ŒæŒ‰ Enter";
                    drawStatus.textContent = "è¼ªåˆ°ä½ äº†ï¼è«‹è¼¸å…¥å§“åï¼";
                } else {
                    participantNameInput.disabled = true;
                    participantNameInput.placeholder = "ç­‰å¾…å…¶ä»–ç©å®¶...";
                    drawStatus.textContent = `ç¾åœ¨è¼ªåˆ°ç¬¬ 1 ä½ç©å®¶...`;
                }
            });

            socket.on('spinResult', (data) => {
                console.log("æ”¶åˆ°æ‹‰éœ¸çµæœ:", data);
                // ç”¨å¤§è…¦çµ¦çš„çµæœä¾†å•Ÿå‹•å°æ‡‰æ»¾è¼ªçš„å‹•ç•«
                triggerSpinAnimation(data.type, data.result);
                if (data.type === 'prize') hasSpunPrize = true;
                if (data.type === 'quantity') hasSpunQuantity = true;
            });
            
            socket.on('newWinner', (newWinner) => {
                winners.push(newWinner);
                renderWinners();
                slotWindow.classList.add('winner-flash');
                setTimeout(() => slotWindow.classList.remove('winner-flash'), 4000);
            });
            
            socket.on('error', (msg) => alert(msg));


            // â˜…â˜…â˜… 3. ä¿®æ”¹å¾Œçš„æ‹‰éœ¸èˆ‡è¼¸å…¥é‚è¼¯ â˜…â˜…â˜…
            participantNameInput.addEventListener('change', () => {
                const name = participantNameInput.value.trim();
                if (!name) return;
                currentParticipantName = name;
                drawStatus.textContent = `ä½ å¥½, ${name}ï¼è«‹æ‹‰å‹•æ‹‰æ¡¿ï¼`;
                participantNameInput.disabled = true;
            });

            function handleSpin(type) {
                if (currentTurnPlayerId !== myPlayerId) {
                    drawStatus.textContent = 'é‚„æ²’è¼ªåˆ°ä½ å–”ï¼';
                    return;
                }
                if (!currentParticipantName) {
                    drawStatus.textContent = 'è«‹å…ˆè¼¸å…¥ä¸¦ç¢ºèªå§“åï¼';
                    return;
                }
                if ((type === 'prize' && hasSpunPrize) || (type === 'quantity' && hasSpunQuantity)) {
                    drawStatus.textContent = 'é€™å€‹æ»¾è¼ªä½ å·²ç¶“è½‰éäº†ï¼';
                    return;
                }
                
                // é€šçŸ¥å¤§è…¦æˆ‘å€‘è¦è½‰å‹•å“ªå€‹æ»¾è¼ª
                console.log(`é€šçŸ¥å¤§è…¦ï¼Œæˆ‘è¦è½‰å‹• ${type} æ»¾è¼ª`);
                socket.emit('spin', { roomId, type, playerName: currentParticipantName });
                
                // ç«‹å³æ’­æ”¾æ‹‰æ¡¿å‹•ç•«
                (type === 'prize' ? leverLeft : leverRight).classList.add('pulled');
                drawStatus.textContent = 'ç¥æ‚¨å¥½é‹ï¼';
            }
            leverLeft.addEventListener('click', () => handleSpin('prize'));
            leverRight.addEventListener('click', () => handleSpin('quantity'));


            // â˜…â˜…â˜… 4. ä¿ç•™å¤§éƒ¨åˆ†ä½ åŸæœ¬çš„å‡½å¼ï¼Œä½†åšå¾®èª¿ â˜…â˜…â˜…
            // ä½ åŸæœ¬çš„ modal, theme, music, export CSV ç­‰åŠŸèƒ½éƒ½ä¿ç•™
            let player;
            window.onYouTubeIframeAPIReady = function() { /* ... YouTube é‚è¼¯ä¿ç•™ ... */ };
            document.getElementById('toggle-music-btn').addEventListener('click', () => { /* ... éŸ³æ¨‚é‚è¼¯ä¿ç•™ ... */ });
            const getPrizeIcon = (name) => { /* ... icon é‚è¼¯ä¿ç•™ ... */ };
            function renderAll() {
                renderPrizes();
                renderQuantities();
                renderPrizeReel();
                renderQuantityReel();
                renderWinners();
            }
            function renderList(list, listEl, type) { /* ... åˆ—è¡¨æ¸²æŸ“é‚è¼¯ä¿ç•™ ... */ }
            const renderPrizes = () => renderList(prizes, prizeList, 'prize');
            const renderQuantities = () => renderList(quantities, quantityList, 'quantity');
            function renderPrizeReel() { /* ... çé …æ»¾è¼ªæ¸²æŸ“é‚è¼¯ä¿ç•™ ... */ }
            function renderQuantityReel() { /* ... æ•¸é‡æ»¾è¼ªæ¸²æŸ“é‚è¼¯ä¿ç•™ ... */ }
            function renderWinners() { /* ... å¾—çè€…æ¸²æŸ“é‚è¼¯ä¿ç•™ ... */ }
            function openItemModal(type, index = null) { /* ... Modal é‚è¼¯ä¿ç•™ ... */ }
            addPrizeBtn.addEventListener('click', () => openItemModal('prize'));
            addQuantityBtn.addEventListener('click', () => openItemModal('quantity'));
            cancelModalBtn.addEventListener('click', () => itemModal.classList.add('hidden'));
            function handleListClick(e) { /* ... åˆ—è¡¨é»æ“Šé‚è¼¯ä¿ç•™ ... */ }
            prizeList.addEventListener('click', handleListClick);
            quantityList.addEventListener('click', handleListClick);
            itemForm.addEventListener('submit', (e) => { /* ... è¡¨å–®æäº¤é‚è¼¯ä¿ç•™ ... */ });
            exportCsvBtn.addEventListener('click', () => { /* ... CSV åŒ¯å‡ºé‚è¼¯ä¿ç•™ ... */ });
            function applyTheme(theme) { /* ... ä¸»é¡Œåˆ‡æ›é‚è¼¯ä¿ç•™ ... */ }
            themeSwitcher.addEventListener('click', (e) => { /* ... ä¸»é¡Œåˆ‡æ›é‚è¼¯ä¿ç•™ ... */ });
            function loadTheme() { /* ... ä¸»é¡Œè®€å–é‚è¼¯ä¿ç•™ ... */ }
            
            // é€™æ˜¯æˆ‘æ–°å¢çš„å‹•ç•«å‡½å¼ï¼Œç”¨ä¾†æ¥æ”¶å¤§è…¦çš„æŒ‡ä»¤ä¸¦æ’­æ”¾å‹•ç•«
            function triggerSpinAnimation(type, finalResultName) {
                const reelEl = type === 'prize' ? prizeReel : quantityReel;
                const leverEl = type === 'prize' ? leverLeft : leverRight;
                const allItemsOnReel = Array.from(reelEl.querySelectorAll('.reel-item'));
                const itemHeight = allItemsOnReel[0]?.offsetHeight || 76;
                const windowHeight = reelEl.parentElement.offsetHeight;

                // æ‰¾åˆ°çµæœåœ¨æ»¾è¼ªä¸­çš„ä½ç½®
                let targetIndex = -1;
                for (let i = 5; i < allItemsOnReel.length; i++) { // å¾ç¬¬5å€‹é–‹å§‹æ‰¾ï¼Œé¿å…å¤ªå¿«åœ
                    if (allItemsOnReel[i].dataset.name === finalResultName) {
                        targetIndex = i;
                        break;
                    }
                }
                if (targetIndex === -1) { // å¦‚æœæ‰¾ä¸åˆ°ï¼Œéš¨æ©Ÿé¸ä¸€å€‹
                    targetIndex = Math.floor(Math.random() * 10) + 5;
                }
                
                const targetPosition = targetIndex * itemHeight;
                const centeredPosition = targetPosition - (windowHeight / 2) + (itemHeight / 2);

                reelEl.style.transition = 'none';
                reelEl.style.transform = 'translateY(0px)';
                void reelEl.offsetWidth;

                const spinDuration = 3000 + Math.random() * 1000;
                reelEl.style.transition = `transform ${spinDuration}ms cubic-bezier(0.25, 0.1, 0.25, 1)`;
                reelEl.style.transform = `translateY(-${centeredPosition}px)`;
                
                setTimeout(() => {
                    leverEl.classList.remove('pulled');
                }, spinDuration - 500);
            }
            
            // é é¢åˆæ¬¡è¼‰å…¥æ™‚åŸ·è¡Œçš„å‡½å¼
            loadTheme();
            renderAll();
        });
    </script>
    <script type="text/javascript" src="https://www.youtube.com/iframe_api"></script>
</body>
</html>